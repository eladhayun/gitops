apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: cert-manager

resources:
  - https://github.com/cert-manager/cert-manager/releases/download/v1.16.1/cert-manager.yaml
  - cluster-issuer.yaml

patches:
  # cert-manager controller - reduce resources
  - target:
      kind: Deployment
      name: cert-manager
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/args/-
        value: --dns01-recursive-nameservers-only
      - op: add
        path: /spec/template/spec/containers/0/args/-
        value: --dns01-recursive-nameservers=8.8.8.8:53,1.1.1.1:53
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            cpu: 10m
            memory: 32Mi
          limits:
            cpu: 100m
            memory: 128Mi
  
  # cert-manager webhook - reduce resources
  - target:
      kind: Deployment
      name: cert-manager-webhook
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            cpu: 5m
            memory: 32Mi
          limits:
            cpu: 50m
            memory: 64Mi
  
  # cert-manager cainjector - reduce resources
  - target:
      kind: Deployment
      name: cert-manager-cainjector
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            cpu: 5m
            memory: 64Mi
          limits:
            cpu: 100m
            memory: 128Mi
  
  # Disable webhook validation initially to allow cert generation
  - target:
      kind: ValidatingWebhookConfiguration
      name: cert-manager-webhook
    patch: |-
      - op: replace
        path: /webhooks/0/failurePolicy
        value: Ignore

